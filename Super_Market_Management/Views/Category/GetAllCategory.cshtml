@model List<Category>
@{
    var activeCategories = Model.Where(c => !c.IsRemoved).ToList();
    var showToast = TempData["DeleteSuccess"] != null && (bool)TempData["DeleteSuccess"];
    var showRestoreToast = TempData["RestoreSuccess"] != null && (bool)TempData["RestoreSuccess"];
}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const deleteToast = document.getElementById("deleteToast");
        if (deleteToast) {
            deleteToast.dataset.show = '@(showToast.ToString().ToLower())';
        }

        const restoreToast = document.getElementById("restoreToast");
        if (restoreToast) {
            restoreToast.dataset.show = '@(showRestoreToast.ToString().ToLower())';
        }
    });
</script>

<main id="main" class="main mt-2 dark-section">
    <section class="section">
        <div class="container-fluid">
            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs mb-4" id="categoryTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button" role="tab">
                        Active Categories (@activeCategories.Count)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="archived-tab" data-bs-toggle="tab" data-bs-target="#archived" type="button" role="tab">
                        Archived (@Model.Count(c => c.IsRemoved))
                    </button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Active Categories Tab -->
                <div class="tab-pane fade show active" id="active" role="tabpanel">
                    <div class="card shadow bg-light">
                        <div class="card-body">
                            <!-- Title & Add Button -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="text-dark mb-0">📂 Active Categories</h4>
                                <div>
                                    <a asp-controller="Category" asp-action="AddEditCategory"
                                       class="btn btn-success rounded-circle shadow me-2"
                                       style="width: 55px; height: 55px;" title="Add Category">
                                        <i class="bi bi-plus-lg fs-4"></i>
                                    </a>
                                    <a href="#exportModal" class="btn btn-primary rounded-circle shadow"
                                       style="width: 55px; height: 55px;" title="Export Categories"
                                       data-bs-toggle="modal">
                                        <i class="bi bi-download fs-4"></i>
                                    </a>
                                </div>
                            </div>

                            @if (!activeCategories.Any())
                            {
                                <div class="text-center text-muted py-4">
                                    <h5>No active categories found.</h5>
                                </div>
                            }
                            else
                            {
                                <!-- Category Grid with Sorting -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>
                                                    <a href="@Url.Action("GetAllCategory", new { sortOrder = ViewBag.NameSortParam })">
                                                        Category Name
                                                        @if (ViewBag.CurrentSort == "name_desc")
                                                        {
                                                            <i class="bi bi-sort-alpha-down-alt"></i>
                                                        }
                                                        else
                                                        {
                                                            <i class="bi bi-sort-alpha-up"></i>
                                                        }
                                                    </a>
                                                </th>
                                                <th>Products Count</th>
                                                <th>Created By</th>
                                                <th>Created On</th>
                                                <th>Last Modified</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var category in activeCategories)
                                            {
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <i class="bi bi-folder-fill me-2 text-primary"></i>
                                                            <strong>@category.CategoryName</strong>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-primary">@(category.Products?.Count ?? 0)</span>
                                                    </td>
                                                    <td>@(category.User?.UserName ?? "System")</td>
                                                    <td>@category.CreationDate?.ToString("dd MMM yyyy")</td>
                                                    <td>@(category.ModifyDate?.ToString("dd MMM yyyy") ?? "Never")</td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <a asp-controller="Category" asp-action="AddEditCategory" asp-route-id="@category.CategoryId"
                                                               class="btn btn-outline-primary" title="Edit">
                                                                <i class="bi bi-pencil"></i>
                                                            </a>
                                                            <button class="btn btn-outline-danger delete-btn"
                                                                    data-id="@category.CategoryId"
                                                                    data-name="@category.CategoryName"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#deleteConfirmModal"
                                                                    title="Archive">
                                                                <i class="bi bi-archive"></i>
                                                            </button>
                                                            <a asp-controller="Product" asp-action="GetAllProduct" asp-route-categoryId="@category.CategoryId"
                                                               class="btn btn-outline-info" title="View Products">
                                                                <i class="bi bi-box-seam"></i>
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Archived Categories Tab -->
                <div class="tab-pane fade" id="archived" role="tabpanel">
                    <div class="card shadow bg-light">
                        <div class="card-body">
                            <h4 class="text-dark mb-4">🗄 Archived Categories</h4>

                            @{
                                var archivedCategories = Model.Where(c => c.IsRemoved).ToList();
                            }

                            @if (!archivedCategories.Any())
                            {
                                <div class="text-center text-muted py-4">
                                    <h5>No archived categories found.</h5>
                                </div>
                            }
                            else
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Category Name</th>
                                                <th>Archived On</th>
                                                <th>Archived By</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var category in archivedCategories)
                                            {
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <i class="bi bi-folder-fill me-2 text-secondary"></i>
                                                            <span class="text-muted">@category.CategoryName</span>
                                                        </div>
                                                    </td>
                                                    <td>@(category.ModifyDate?.ToString("dd MMM yyyy") ?? "Unknown")</td>
                                                    <td>@(category.User?.UserName ?? "System")</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-success restore-btn"
                                                                data-id="@category.CategoryId"
                                                                data-name="@category.CategoryName"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#restoreConfirmModal">
                                                            <i class="bi bi-arrow-counterclockwise"></i> Restore
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">Archive Category</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteModalText">Are you sure you want to archive this category?</p>
                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    Archiving will hide the category but preserve all related products.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="#" id="confirmDeleteBtn" class="btn btn-danger">
                    <i class="bi bi-archive"></i> Archive
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Restore Confirmation Modal -->
<div class="modal fade" id="restoreConfirmModal" tabindex="-1" aria-labelledby="restoreModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-success">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="restoreModalLabel">Restore Category</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="restoreModalText">Are you sure you want to restore this category?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="#" id="confirmRestoreBtn" class="btn btn-success">
                    <i class="bi bi-arrow-counterclockwise"></i> Restore
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Categories</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Format</label>
                    <select class="form-select">
                        <option>Excel (.xlsx)</option>
                        <option>CSV (.csv)</option>
                        <option>PDF (.pdf)</option>
                    </select>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeProducts">
                    <label class="form-check-label" for="includeProducts">
                        Include products in each category
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Export</button>
            </div>
        </div>
    </div>
</div>

<!-- Toasts -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999;">
    <!-- Delete Toast -->
    <div id="deleteToast" class="toast text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle-fill me-2"></i>
                Category archived successfully!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>

    <!-- Restore Toast -->
    <div id="restoreToast" class="toast text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle-fill me-2"></i>
                Category restored successfully!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Delete Confirmation
            const deleteButtons = document.querySelectorAll(".delete-btn");
            const deleteModalText = document.getElementById('deleteModalText');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

            deleteButtons.forEach(button => {
                button.addEventListener("click", function () {
                    const categoryId = this.getAttribute("data-id");
                    const categoryName = this.getAttribute("data-name");

                    deleteModalText.innerHTML = `Are you sure you want to archive <strong>${categoryName}</strong>?`;
                    confirmDeleteBtn.setAttribute("href", `/Category/DeleteCategory/${categoryId}`);
                });
            });

            // Restore Confirmation
            const restoreButtons = document.querySelectorAll(".restore-btn");
            const restoreModalText = document.getElementById('restoreModalText');
            const confirmRestoreBtn = document.getElementById('confirmRestoreBtn');

            restoreButtons.forEach(button => {
                button.addEventListener("click", function () {
                    const categoryId = this.getAttribute("data-id");
                    const categoryName = this.getAttribute("data-name");

                    restoreModalText.innerHTML = `Are you sure you want to restore <strong>${categoryName}</strong>?`;
                    confirmRestoreBtn.setAttribute("href", `/Category/RestoreCategory/${categoryId}`);
                });
            });

            // Toast handling
            const deleteToastEl = document.getElementById("deleteToast");
            if (deleteToastEl && deleteToastEl.dataset.show === "true") {
                const toast = new bootstrap.Toast(deleteToastEl);
                toast.show();
            }

            const restoreToastEl = document.getElementById("restoreToast");
            if (restoreToastEl && restoreToastEl.dataset.show === "true") {
                const toast = new bootstrap.Toast(restoreToastEl);
                toast.show();
            }
        });
    </script>
}