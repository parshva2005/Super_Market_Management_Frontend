@model User
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "My Profile";
    var userImage = !string.IsNullOrEmpty(Model.FilePath) ? "https://localhost:7210/@Model.FilePath" : null;
    if(Context.Session.GetString("RoleName") == "Customer"){
        Layout = "_LayoutCustomer";
    }
    
}

<div class="profile-container">
    <div class="row justify-content-between align-items-center mb-4">
        <div class="col">
            <h2 class="mb-0">My Profile</h2>
        </div>
        <div class="col-auto">
            <span class="badge bg-primary">@Model.Role?.RoleName</span>
        </div>
    </div>
    
    <form asp-action="Profile" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
        <input type="hidden" asp-for="UserId" value="@Context.Session.GetInt32("UserId")" />
        
        <div class="row">
            <!-- Left Column - Profile Image -->
            <div class="col-md-4 mb-4">
                <div class="profile-image-section text-center">
                    <div class="profile-image-wrapper mx-auto">
                        
                            <img id="profileImagePreview" src="https://localhost:7210/@Model.FilePath" alt="Profile Image" class="profile-image" >
                        
                        <label for="imageUpload" class="image-upload-label" title="Change profile picture">
                            <i class="bi bi-plus-circle-fill"></i>
                        </label>
                        <input type="file" id="imageUpload" name="file" accept="image/*" class="image-upload-input" asp-for="File">
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">Click the + icon to upload a profile picture</small>
                    </div>
                    
                    <div class="profile-info mt-4">
                        <p class="mb-1"><strong>Member since:</strong> @Model.CreationDate?.ToString("MMMM yyyy")</p>
                        <p class="mb-0"><strong>Last updated:</strong> @(Model.ModifyDate?.ToString("MMMM dd, yyyy") ?? "Never")</p>
                    </div>
                </div>
            </div>

            <!-- Right Column - Profile Details -->
            <div class="col-md-8">
                <div class="profile-details-section">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0">Personal Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label asp-for="UserName" class="form-label">Full Name *</label>
                                    <input asp-for="UserName" class="form-control" required />
                                    <span asp-validation-for="UserName" class="text-danger"></span>
                                    <div class="invalid-feedback">Please provide your full name.</div>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="UserEmailAddress" class="form-label">Email Address *</label>
                                    <input asp-for="UserEmailAddress" type="email" class="form-control" required />
                                    <span asp-validation-for="UserEmailAddress" class="text-danger"></span>
                                    <div class="invalid-feedback">Please provide a valid email address.</div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label asp-for="UserMobileNumber" class="form-label">Mobile Number *</label>
                                    <input asp-for="UserMobileNumber" class="form-control" required />
                                    <span asp-validation-for="UserMobileNumber" class="text-danger"></span>
                                    <div class="invalid-feedback">Please provide your mobile number.</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Account Type</label>
                                    <input class="form-control" value="@Model.Role?.RoleName" disabled />
                                </div>
                            </div>

                            <div class="mb-3">
                                <label asp-for="UserAddress" class="form-label">Address *</label>
                                <textarea asp-for="UserAddress" class="form-control" rows="3" required></textarea>
                                <span asp-validation-for="UserAddress" class="text-danger"></span>
                                <div class="invalid-feedback">Please provide your address.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Account Security Section -->
                    <div class="card mt-4">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0">Account Security</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label asp-for="Password" class="form-label">Password</label>
                                    <div class="input-group">
                                        <input asp-for="Password" type="text" class="form-control"
                                               autocomplete="new-password" />
                                        <button class="btn btn-outline-secondary toggle-password" type="button">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <span asp-validation-for="Password" class="text-danger"></span>
                                </div>

                                <div class="col-md-6">
                                    <label asp-for="ConfirmPassword" class="form-label">Confirm Password</label>
                                    <div class="input-group">
                                        <input asp-for="ConfirmPassword" type="text" class="form-control"
                                               autocomplete="new-password" />
                                        <button class="btn btn-outline-secondary toggle-password" type="button">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Update Profile
                        </button>
                        @if (Context.Session.GetString("RoleName") == "Customer")
                        {
                            <a asp-controller="Product" asp-action="GetAllProductCustomer" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-2"></i>Cancel
                            </a>
                        }
                        else
                        {
                            <a asp-controller="Product" asp-action="GetAllProduct" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-2"></i>Cancel
                            </a>
                        }

                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // Image preview functionality
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Validate file type
                const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!validImageTypes.includes(file.type)) {
                    alert('Please select a valid image file (JPEG, PNG, GIF, or WEBP).');
                    this.value = '';
                    return;
                }

                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Please select an image smaller than 5MB.');
                    this.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    // Hide default image and show uploaded image preview
                    const defaultPreview = document.getElementById('defaultImagePreview');
                    if (defaultPreview) {
                        defaultPreview.style.display = 'none';
                    }
                    
                    let imagePreview = document.getElementById('profileImagePreview');
                    if (!imagePreview) {
                        imagePreview = document.createElement('img');
                        imagePreview.id = 'profileImagePreview';
                        imagePreview.className = 'profile-image';
                        imagePreview.alt = 'Profile Image';
                        document.querySelector('.profile-image-wrapper').prepend(imagePreview);
                    }
                    
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });

        // Form validation
        (function () {
            'use strict'
            var forms = document.querySelectorAll('.needs-validation')
            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        if (!form.checkValidity()) {
                            event.preventDefault()
                            event.stopPropagation()
                        }
                        form.classList.add('was-validated')
                    }, false)
                })
        })();

        // Show success/error messages
        $(document).ready(function() {
            @if (TempData["Success"] != null)
            {
                <text>showToast('Success', '@TempData["Success"]', 'success');</text>
            }
            @if (TempData["Error"] != null)
            {
                <text>showToast('Error', '@TempData["Error"]', 'error');</text>
            }
        });

        function showToast(title, message, type) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${title}:</strong> ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            document.querySelector('.toast-container').appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
    </script>
}